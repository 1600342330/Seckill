# Seckill

#### 介绍
高并发下的秒杀系统

#### 项目亮点

 - 使用分布式`Session`，可以实现让多台服务器同时可以响应。
 - 使用`Redis`做缓存提高访问速度和并发量，减少数据库压力，利用内存标记减少`Redis`的访问。
 - 使用页面静态化，加快用户访问速度，提高`QPS`，缓存页面至浏览器，前后端分离降低服务器压力。
 - 使用消息队列完成异步下单，提升用户体验，削峰和降流。
 - 安全性优化：双重`Md5`密码校验，秒杀接口地址的隐藏，接口限流防刷。

#### 项目涉及知识点
**分布式Session**
我们的秒杀服务，实际的应用可能不止部署在一个服务器上，而是分布式的多台服务器，这时候假如用户登录是在第一个服务器，第一个请求到了第一台服务器，但是第二个请求到了第二个服务器，那么用户的`session`信息就丢失了。
解决：`session`同步，无论访问那一台服务器，`session`都可以取得到，利用`redis`缓存的方法，另外使用一个`redis`服务器专门用于存放用户的`session`信息。这样就不会出现用户`session`丢失的情况。（每次需要`session`，从缓存中取即可）

**Redis缓解数据库压力**
本项目大量的利用了缓存技术，包括用户信息缓存（分布式`session`），商品信息的缓存，商品库存缓存，订单的缓存，页面缓存，对象缓存减少了对数据库服务器的访问。

**通用缓存Key封装**
大量的缓存引用也出现了一个问题，如何识别不同模块中的缓存（`key`值重复，如何辨别是不同模块的`key`）
解决：利用一个抽象类，定义`BasePrefix`（前缀），在里面定义缓存`key`的前缀以及缓存的过期时间从而实现将缓存的`key`进行封装。让不同模块继承它，这样每次存入一个模块的缓存的时候，加上这个缓存特定的前缀，以及可以统一制定不同的过期时间。

**页面静态化（前后端分离）**
页面静态化的主要目的是为了加快页面的加载速度，将商品的详情和订单详情页面做成静态`HTML`（纯`HTML`），数据的加载只需要通过`ajax`来请求服务器，并且做了静态化`HTML`页面可以缓存在客户端的浏览器。

**消息队列完成异步下单，提升用户体验，削峰和降流**
 1. 系统初始化，把商品秒杀库存数量`stock_count`加载到`Redis`上面来。
 2. 后端收到秒杀请求，`Redis`预减库存，如果库存已经到达临界值的时候，就不需要继续请求下去，直接返回失败，即后面的大量请求无需给系统带来压力。
 3. 判断这个秒杀订单形成没有，判断是否已经秒杀到了，避免一个账户秒杀多个商品，判断是否重复秒杀。
 4. 库存充足，且无重复秒杀，将秒杀请求封装后消息入队，同时给前端返回一个`code(0)`，即代表返回排队中。（返回的并不是失败或者成功，此时还不能判断）
 5. 前端接收到数据后，显示排队中，并根据商品id轮询请求服务器（考虑`100ms`轮询一次）。
 6. 后端`RabbitMQ`监听秒杀`MIAOSHA_QUEUE`的这名字的通道，如果有消息过来，获取到传入的信息，执行真正的秒杀之前，要判断数据库的库存，判断是否重复秒杀，然后执行秒杀事务（秒杀事务是一个原子操作：库存减`1`，下订单，写入秒杀订单）。
 7. 此时，前端根据商品id轮询请求接口`/getmiaoshadetail`,查看是否生成了商品订单，如果请求返回`-1`代表秒杀失败，返回`0`代表排队中，返回`>0`代表商品`id`说明秒杀成功。

**安全性优化**
双重`md5`密码校验，秒杀接口地址的隐藏，接口限流防刷。

**优雅的代码编写**
接口的输出结果做了一个`Result`封装
对错误的代码做了一个`CodeMsg`的封装
访问缓存做了`key`的封装，`Redis`常用操作的封装


#### 秒杀架构设计理念
 - 限流： 鉴于只有少部分用户能够秒杀成功，所以要限制大部分流量，只允许少部分流量进入服务后端。
 - 削峰：对于秒杀系统瞬时会有大量用户涌入，所以在抢购一开始会有很高的瞬间峰值。高峰值流量是压垮系统很重要的原因，所以如何把瞬间的高流量变成一段时间平稳的流量也是设计秒杀系统很重要的思路。实现削峰的常用的方法有利用缓存和消息中间件等技术。
 - 异步处理：秒杀系统是一个高并发系统，采用异步处理模式可以极大地提高系统并发量，其实异步处理就是削峰的一种实现方式。
 - 内存缓存：秒杀系统最大的瓶颈一般都是数据库读写，我们的原则是数据库只承担能力范围内的读写，由于数据库读写属于磁盘IO，性能很低，如果能够把部分数据或业务逻辑转移到内存缓存，效率会有极大地提升。
 - 可拓展：当然如果我们想支持更多用户，更大的并发，最好就将系统设计成弹性可拓展的，如果流量来了，拓展机器就好了。像淘宝、京东等双十一活动时会增加大量机器应对交易高峰。

#### 更多
该项目核心实现已更新到本人博客，欢迎大家浏览指正
 [https://kexing.site/](https://kexing.site/)

